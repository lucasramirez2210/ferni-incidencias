<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1E3A5F">
    <title>FERNI - Sistema de Incidencias</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ========================================
        // FIREBASE CONFIG
        // ========================================
        const firebaseConfig = {
          apiKey: "AIzaSyASCknH-hS84WKM4sGFehfVraXKm6T-ob0",
          authDomain: "ferni-incidencias.firebaseapp.com",
          projectId: "ferni-incidencias",
          storageBucket: "ferni-incidencias.firebasestorage.app",
          messagingSenderId: "744424538106",
          appId: "1:744424538106:web:8392fbe4f3e8c9b5e7c8d9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ========================================
        // CONSTANTES
        // ========================================
        const DIAS_RETENCION = 90;
        
        const ADMINS = [
          { nombre: 'Lucas', email: 'lucas.ramirez2210@gmail.com', password: 'ferni2025' }
        ];

        // Gerentes de tienda: usuario predeterminado por sucursal
        const GERENTES = {
          'gerenteferni1': 'F1',
          'gerenteferni2': 'F2',
          'gerenteferni3': 'F3',
          'gerenteferni4': 'F4',
          'gerenteferni5': 'F5',
          'gerenteferni6': 'F6',
          'gerenteferni7': 'F7',
          'gerenteferni8': 'F8',
          'gerenteferni9': 'F9'
        };
        
        const SUCURSALES = [
          { id: 'F1', nombre: 'FERNI 1' },
          { id: 'F2', nombre: 'FERNI 2' },
          { id: 'F3', nombre: 'FERNI 3' },
          { id: 'F4', nombre: 'FERNI 4' },
          { id: 'F5', nombre: 'FERNI 5' },
          { id: 'F6', nombre: 'FERNI 6' },
          { id: 'F7', nombre: 'FERNI 7' },
          { id: 'F8', nombre: 'FERNI 8' },
          { id: 'F9', nombre: 'FERNI 9' }
        ];

        const CATEGORIAS = [
          { id: 'visual', nombre: 'Exhibiciones', color: '#000000', icon: 'üéØ' },
          { id: 'limpieza', nombre: 'Limpieza y Orden', color: '#000000', icon: 'üßπ' },
          { id: 'mantenimiento', nombre: 'Mantenimiento', color: '#000000', icon: 'üîß' },
          { id: 'inventario', nombre: 'Inventario', color: '#000000', icon: 'üì¶' },
          { id: 'ambiental', nombre: 'Mejoras Ambientales', color: '#000000', icon: '‚ôªÔ∏è' }
        ];

        // ========================================
        // HELPERS DE FECHA
        // ========================================
        const getFecha = (campo) => {
          if (!campo) return null;
          if (campo.toDate) return campo.toDate();
          return new Date(campo);
        };

        const formatFecha = (campo) => {
          const fecha = getFecha(campo);
          if (!fecha || isNaN(fecha)) return 'N/A';
          return fecha.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        // ========================================
        // COMPRIMIR FOTO
        // ========================================
        const comprimirFoto = (file, maxWidth = 800, quality = 0.7) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                  height = (height * maxWidth) / width;
                  width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => {
                  if (blob) {
                    const compressedFile = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                    console.log(`‚úÖ Foto comprimida: ${(file.size/1024).toFixed(0)}KB ‚Üí ${(blob.size/1024).toFixed(0)}KB`);
                    resolve(compressedFile);
                  } else reject(new Error('Error al comprimir'));
                }, 'image/jpeg', quality);
              };
              img.onerror = () => reject(new Error('Error al cargar imagen'));
              img.src = e.target.result;
            };
            reader.onerror = () => reject(new Error('Error al leer archivo'));
            reader.readAsDataURL(file);
          });
        };

        // ========================================
        // SUBIR FOTO: intenta Storage, si falla ‚Üí base64
        // ========================================
        const subirFoto = (file, carpeta = 'reportes') => {
          return new Promise((resolve) => {
            // Intentar subir a Storage con timeout de 10s
            const timeout = setTimeout(() => {
              console.warn('‚ö†Ô∏è Storage timeout, cayendo a base64');
              resolve(null); // se√±al para usar base64
            }, 10000);

            const storageRef = storage.ref(`${carpeta}/${Date.now()}_${file.name}`);
            storageRef.put(file).then(async () => {
              clearTimeout(timeout);
              const url = await storageRef.getDownloadURL();
              console.log('‚úÖ Foto subida a Storage');
              resolve(url);
            }).catch((err) => {
              clearTimeout(timeout);
              console.warn('‚ö†Ô∏è Storage fall√≥, cayendo a base64:', err.message);
              resolve(null);
            });
          });
        };

        // Convierte un File a string base64
        const fileToBase64 = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        };
        // ========================================
        const limpiarFotosViejas = async () => {
          try {
            console.log('üßπ Iniciando limpieza de fotos antiguas...');
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - DIAS_RETENCION);

            // Solo where por estado, sin orderBy ‚Üí no necesita √≠ndice compuesto
            const snapshot = await db.collection('reportes')
              .where('estado', '==', 'resuelto')
              .get();

            let fotosEliminadas = 0;

            for (const doc of snapshot.docs) {
              const reporte = doc.data();
              const fecha = getFecha(reporte.fecha_creacion);
              if (!fecha || fecha >= fechaLimite) continue;
              if (!reporte.foto_problema && !reporte.foto_solucion) continue;

              // Si es URL de Storage, intentar borrar del storage
              if (reporte.foto_problema && reporte.foto_problema.startsWith('http')) {
                try { await storage.refFromURL(reporte.foto_problema).delete(); } catch(e) {}
              }
              if (reporte.foto_solucion && reporte.foto_solucion.startsWith('http')) {
                try { await storage.refFromURL(reporte.foto_solucion).delete(); } catch(e) {}
              }

              await doc.ref.update({ foto_problema: null, foto_solucion: null });
              fotosEliminadas++;
            }

            console.log(`‚úÖ Limpieza completada: ${fotosEliminadas} fotos eliminadas, 0 errores`);
          } catch (error) {
            console.error('‚ùå Error en limpieza autom√°tica:', error);
          }
        };

        // ========================================
        // COMPONENTE PRINCIPAL
        // ========================================
        function FerniApp() {
          const [vista, setVista] = useState('login');
          const [usuario, setUsuario] = useState(null);
          const [usuarioEmail, setUsuarioEmail] = useState(null);
          const [sucursalUsuario, setSucursalUsuario] = useState(null);
          const [sucursalActiva, setSucursalActiva] = useState(null);
          const [esAdmin, setEsAdmin] = useState(false);
          const [esGerente, setEsGerente] = useState(false);
          const [reportes, setReportes] = useState([]);
          const [reportesNuevos, setReportesNuevos] = useState([]);
          const [contadorNuevos, setContadorNuevos] = useState(0);
          const [filtroEstado, setFiltroEstado] = useState('todos');
          const [reporteActual, setReporteActual] = useState(null);
          const [cargando, setCargando] = useState(false);

          // Limpieza autom√°tica (solo admins)
          useEffect(() => {
            if (esAdmin || esGerente) {
              limpiarFotosViejas();
            }
          }, [esAdmin, esGerente]);

          // Cargar reportes ‚Äî sin orderBy en Firestore, ordenamos en JS
          useEffect(() => {
            if (!usuario || !sucursalActiva) return;

            // Obtener timestamp de √∫ltima visita
            const ultimaVisitaKey = `ultimaVisita_${sucursalActiva}`;
            const ultimaVisita = localStorage.getItem(ultimaVisitaKey);
            const timestampUltimaVisita = ultimaVisita ? new Date(ultimaVisita) : new Date(0);

            let query = db.collection('reportes');
            if (sucursalActiva !== 'TODAS') {
              query = query.where('sucursal', '==', sucursalActiva);
            }

            let primeraVez = true;

            const unsubscribe = query.onSnapshot((snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              
              // Ordenar por fecha_creacion DESC en JavaScript
              data.sort((a, b) => {
                const fa = getFecha(a.fecha_creacion) || new Date(0);
                const fb = getFecha(b.fecha_creacion) || new Date(0);
                return fb - fa;
              });

              // Contar reportes nuevos desde √∫ltima visita
              const nuevos = data.filter(r => {
                const fecha = getFecha(r.fecha_creacion);
                return fecha && fecha > timestampUltimaVisita;
              });
              setContadorNuevos(nuevos.length);

              // Detectar reportes que acaban de llegar (solo despu√©s de primera carga)
              if (!primeraVez) {
                const idsAnteriores = new Set(reportes.map(r => r.id));
                const recienLlegados = data.filter(r => !idsAnteriores.has(r.id)).map(r => r.id);
                setReportesNuevos(recienLlegados);
                // Quitar highlight despu√©s de 5 segundos
                if (recienLlegados.length > 0) {
                  setTimeout(() => setReportesNuevos([]), 5000);
                }
              }
              primeraVez = false;

              setReportes(data);
            });

            return () => unsubscribe();
          }, [usuario, sucursalActiva]);

          // ========================================
          // LOGIN
          // ========================================
          const VistaLogin = () => {
            const [tipoLogin, setTipoLogin] = useState('empleado');
            const [nombre, setNombre] = useState('');
            const [sucursal, setSucursal] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleLoginEmpleado = () => {
              if (!nombre.trim() || !email.trim() || !sucursal) { alert('Complet√° nombre, email y sucursal'); return; }
              const emailLower = email.trim().toLowerCase();
              const gerenteSucursal = GERENTES[emailLower];
              
              if (gerenteSucursal) {
                // Es un gerente de tienda
                if (gerenteSucursal !== sucursal) {
                  alert(`‚ö†Ô∏è El usuario ${emailLower} corresponde a ${SUCURSALES.find(s => s.id === gerenteSucursal)?.nombre}. Seleccion√° la sucursal correcta.`);
                  return;
                }
                setUsuario(nombre.trim());
                setUsuarioEmail(emailLower);
                setSucursalUsuario(sucursal);
                setSucursalActiva(sucursal);
                setEsAdmin(false);
                setEsGerente(true);
                setVista('lista');
              } else {
                // Empleado com√∫n
                setUsuario(nombre.trim());
                setUsuarioEmail(emailLower);
                setSucursalUsuario(sucursal);
                setSucursalActiva(sucursal);
                setEsAdmin(false);
                setEsGerente(false);
                setVista('lista');
              }
            };

            const handleLoginAdmin = () => {
              if (!email.trim() || !password.trim()) { alert('Complet√° email y contrase√±a'); return; }
              const admin = ADMINS.find(a => a.email === email && a.password === password);
              if (!admin) { alert('‚ùå Email o contrase√±a incorrectos'); return; }
              setUsuario(admin.nombre);
              setUsuarioEmail(email.trim().toLowerCase());
              setSucursalUsuario('TODAS');
              setSucursalActiva('TODAS');
              setEsAdmin(true);
              setEsGerente(false);
              setVista('lista');
            };

            return (
              <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                  <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">FERNI</h1>
                    <p className="text-gray-600">Sistema de Incidencias</p>
                  </div>
                  
                  <div className="flex gap-2 mb-6">
                    <button onClick={() => setTipoLogin('empleado')} className={`flex-1 py-3 rounded-lg font-semibold transition ${tipoLogin === 'empleado' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>Usuario</button>
                    <button onClick={() => setTipoLogin('admin')} className={`flex-1 py-3 rounded-lg font-semibold transition ${tipoLogin === 'admin' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>Admin</button>
                  </div>

                  {tipoLogin === 'empleado' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Tu nombre</label>
                        <input type="text" placeholder="Nombre y Apellido" value={nombre} onChange={(e) => setNombre(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Tu email</label>
                        <input type="email" placeholder="tu.email@ejemplo.com" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Tu sucursal</label>
                        <select value={sucursal} onChange={(e) => setSucursal(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-white">
                          <option value="">Seleccion√° tu tienda</option>
                          {SUCURSALES.map(s => <option key={s.id} value={s.id}>{s.nombre}</option>)}
                        </select>
                      </div>
                      <button onClick={handleLoginEmpleado} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Ingresar</button>
                    </div>
                  )}

                  {tipoLogin === 'admin' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" placeholder="admin@ferni.com" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                        <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password} onChange={(e) => setPassword(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleLoginAdmin()} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" />
                      </div>
                      <button onClick={handleLoginAdmin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Ingresar como Admin</button>
                    </div>
                  )}
                </div>
              </div>
            );
          };

          // ========================================
          // LISTA DE REPORTES
          // ========================================
          const VistaLista = () => {
            const reportesFiltrados = reportes.filter(r => filtroEstado === 'todos' || r.estado === filtroEstado);
            const sucursalNombre = sucursalActiva === 'TODAS' ? 'Todas las Sucursales' : SUCURSALES.find(s => s.id === sucursalActiva)?.nombre || sucursalActiva;

            // Marcar como visto al interactuar
            const marcarVisto = () => {
              const ultimaVisitaKey = `ultimaVisita_${sucursalActiva}`;
              localStorage.setItem(ultimaVisitaKey, new Date().toISOString());
              setContadorNuevos(0);
            };

            // Auto-marcar despu√©s de 3 segundos si hay nuevos
            useEffect(() => {
              if (contadorNuevos > 0) {
                const timer = setTimeout(marcarVisto, 3000);
                return () => clearTimeout(timer);
              }
            }, [contadorNuevos]);

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 shadow-lg">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-1">
                        <h1 className="text-2xl font-bold">FERNI Incidencias</h1>
                        {contadorNuevos > 0 && (
                          <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">
                            {contadorNuevos} nuevo{contadorNuevos > 1 ? 's' : ''}
                          </span>
                        )}
                      </div>
                      <p className="text-blue-100 text-sm">Hola, {usuario} {esAdmin && 'üëë'} {esGerente && 'üè™ Gerente'}</p>
                      
                      {esAdmin ? (
                        <div className="mt-3">
                          <select value={sucursalActiva} onChange={(e) => setSucursalActiva(e.target.value)} className="px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30 text-sm font-medium focus:outline-none focus:bg-white/30">
                            <option value="TODAS" style={{color:'#000'}}>üìä Todas las sucursales</option>
                            {SUCURSALES.map(s => <option key={s.id} value={s.id} style={{color:'#000'}}>{s.nombre}</option>)}
                          </select>
                        </div>
                      ) : (
                        <div className="mt-2 text-blue-100 text-sm">üìç {sucursalNombre}</div>
                      )}
                    </div>
                    <button onClick={() => setVista('dashboard')} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition text-sm">üìä Dashboard</button>
                  </div>
                  
                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.length}</div>
                      <div className="text-xs text-blue-100">Total</div>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.filter(r => r.estado === 'abierto').length}</div>
                      <div className="text-xs text-blue-100">Abiertos</div>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.filter(r => r.estado === 'resuelto').length}</div>
                      <div className="text-xs text-blue-100">Resueltos</div>
                    </div>
                  </div>
                </div>

                <div className="p-4 bg-white border-b flex gap-2 overflow-x-auto">
                  {['todos', 'abierto', 'resuelto'].map(estado => (
                    <button key={estado} onClick={() => setFiltroEstado(estado)} className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap transition ${filtroEstado === estado ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                      {estado === 'todos' ? 'üìã Todos' : estado === 'abierto' ? 'üî¥ Abiertos' : '‚úÖ Resueltos'}
                    </button>
                  ))}
                </div>

                <div className="p-4 space-y-3 pb-24">
                  {reportesFiltrados.length === 0 ? (
                    <div className="text-center py-12 text-gray-400">
                      <div className="text-6xl mb-4">üì≠</div>
                      <p>No hay reportes</p>
                    </div>
                  ) : (
                    reportesFiltrados.map(reporte => {
                      const categoria = CATEGORIAS.find(c => c.id === reporte.categoria);
                      const sucursal = SUCURSALES.find(s => s.id === reporte.sucursal);
                      const esNuevo = reportesNuevos.includes(reporte.id);
                      return (
                        <div 
                          key={reporte.id} 
                          onClick={() => { setReporteActual(reporte); setVista('detalle'); marcarVisto(); }} 
                          className={`bg-white rounded-lg p-4 shadow hover:shadow-md transition cursor-pointer ${esNuevo ? 'ring-2 ring-green-400 animate-pulse' : ''}`} 
                          style={{ borderLeft: `4px solid ${categoria?.color}` }}
                        >
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex items-center gap-2 flex-1">
                              {esNuevo && <span className="text-green-500 text-xl">‚ú®</span>}
                              <span className="text-2xl">{categoria?.icon}</span>
                              <div className="flex-1">
                                <div className="font-semibold text-gray-800">{categoria?.nombre}</div>
                                <div className="text-sm text-gray-500">
                                  Por {reporte.usuario_reporta}
                                  {sucursalActiva === 'TODAS' && sucursal && <span className="ml-2 text-blue-600">‚Ä¢ {sucursal.nombre}</span>}
                                </div>
                              </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${reporte.estado === 'abierto' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                              {reporte.estado === 'abierto' ? 'üî¥ Abierto' : '‚úÖ Resuelto'}
                            </span>
                          </div>
                          <p className="text-gray-600 text-sm mb-2 line-clamp-2">{reporte.descripcion}</p>
                          <div className="text-xs text-gray-400">{formatFecha(reporte.fecha_creacion)}</div>
                        </div>
                      );
                    })
                  )}
                </div>

                <button onClick={() => setVista('crear')} className="fixed bottom-6 right-6 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg hover:bg-blue-700 transition flex items-center justify-center text-3xl">+</button>
              </div>
            );
          };

          // ========================================
          // CREAR REPORTE
          // ========================================
          const VistaCrear = () => {
            const [categoria, setCategoria] = useState('');
            const [descripcion, setDescripcion] = useState('');
            const [foto, setFoto] = useState(null);
            const [previsualizacion, setPrevisualizacion] = useState(null);

            const handleFotoChange = async (e) => {
              const file = e.target.files[0];
              if (file) {
                try {
                  const fotoComprimida = await comprimirFoto(file);
                  setFoto(fotoComprimida);
                  const reader = new FileReader();
                  reader.onload = (e) => setPrevisualizacion(e.target.result);
                  reader.readAsDataURL(fotoComprimida);
                } catch (error) {
                  console.error('Error al comprimir foto:', error);
                  alert('Error al procesar la foto');
                }
              }
            };

            const handleCrear = async () => {
              if (!categoria || !descripcion || !foto) { alert('Complet√° todos los campos'); return; }
              setCargando(true);
              try {
                // Intentar Storage; si falla, usar base64
                let fotoGuardar = await subirFoto(foto, 'reportes');
                if (!fotoGuardar) {
                  console.log('üì¶ Guardando foto como base64...');
                  fotoGuardar = await fileToBase64(foto);
                }

                await db.collection('reportes').add({
                  categoria,
                  descripcion,
                  foto_problema: fotoGuardar,
                  foto_solucion: null,
                  usuario_reporta: usuario,
                  usuario_reporta_email: usuarioEmail,
                  usuario_resuelve: null,
                  usuario_resuelve_email: null,
                  estado: 'abierto',
                  fecha_creacion: new Date(),
                  fecha_resolucion: null,
                  analisis_ia: null,
                  sucursal: esAdmin && sucursalActiva !== 'TODAS' ? sucursalActiva : sucursalUsuario,
                  comentarios: []
                });

                alert('‚úÖ Reporte creado exitosamente');
                setVista('lista');
              } catch (error) {
                console.error('‚ùå Error al crear reporte:', error);
                alert('Error al crear reporte: ' + error.message);
              } finally {
                setCargando(false);
              }
            };

            const sucursalCrear = esAdmin && sucursalActiva !== 'TODAS' ? sucursalActiva : sucursalUsuario;

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-blue-600 text-white p-6">
                  <button onClick={() => setVista('lista')} className="mb-4 text-blue-100 hover:text-white">‚Üê Volver</button>
                  <h1 className="text-2xl font-bold">Nuevo Reporte</h1>
                  <p className="text-blue-100 text-sm mt-1">{SUCURSALES.find(s => s.id === sucursalCrear)?.nombre}</p>
                </div>

                <div className="p-6 space-y-6">
                  <div>
                    <label className="block text-gray-700 font-semibold mb-3">Categor√≠a</label>
                    <div className="grid grid-cols-1 gap-3">
                      {CATEGORIAS.map(cat => (
                        <button key={cat.id} onClick={() => setCategoria(cat.id)} className={`p-4 rounded-lg border-2 transition text-left ${categoria === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white hover:border-gray-300'}`}>
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">{cat.icon}</span>
                            <span className="font-medium" style={{ color: cat.color }}>{cat.nombre}</span>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-gray-700 font-semibold mb-2">Descripci√≥n</label>
                    <textarea value={descripcion} onChange={(e) => setDescripcion(e.target.value)} placeholder="Describ√≠ el problema..." className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" rows="4" />
                  </div>

                  <div>
                    <label className="block text-gray-700 font-semibold mb-2">Foto del problema</label>
                    <input type="file" accept="image/*" onChange={handleFotoChange} className="hidden" id="foto-input" />
                    <label htmlFor="foto-input" className="block w-full p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-blue-500 transition">
                      {previsualizacion ? (
                        <img src={previsualizacion} alt="Preview" className="max-h-48 mx-auto rounded" />
                      ) : (
                        <>
                          <div className="text-4xl mb-2">üì∑</div>
                          <div className="text-gray-600">Tocar para tomar foto</div>
                        </>
                      )}
                    </label>
                  </div>

                  <button onClick={handleCrear} disabled={cargando || !categoria || !descripcion || !foto} className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                    {cargando ? 'Creando...' : '‚úÖ Crear Reporte'}
                  </button>
                </div>
              </div>
            );
          };

          // ========================================
          // DETALLE DE REPORTE
          // ========================================
          const VistaDetalle = () => {
            if (!reporteActual) return null;

            const categoria = CATEGORIAS.find(c => c.id === reporteActual.categoria);
            const sucursal = SUCURSALES.find(s => s.id === reporteActual.sucursal);
            const [fotoSolucion, setFotoSolucion] = useState(null);
            const [previsualizacionSolucion, setPrevisualizacionSolucion] = useState(null);
            const [nuevoComentario, setNuevoComentario] = useState('');

            const handleFotoSolucionChange = async (e) => {
              const file = e.target.files[0];
              if (file) {
                try {
                  const fotoComprimida = await comprimirFoto(file);
                  setFotoSolucion(fotoComprimida);
                  const reader = new FileReader();
                  reader.onload = (e) => setPrevisualizacionSolucion(e.target.result);
                  reader.readAsDataURL(fotoComprimida);
                } catch (error) {
                  console.error('Error al comprimir foto:', error);
                  alert('Error al procesar la foto');
                }
              }
            };

            const handleResolver = async () => {
              if (!fotoSolucion) { alert('Tom√° una foto de la soluci√≥n'); return; }
              setCargando(true);
              try {
                // Intentar Storage; si falla, usar base64
                let fotoGuardar = await subirFoto(fotoSolucion, 'soluciones');
                if (!fotoGuardar) {
                  console.log('üì¶ Guardando foto soluci√≥n como base64...');
                  fotoGuardar = await fileToBase64(fotoSolucion);
                }

                await db.collection('reportes').doc(reporteActual.id).update({
                  estado: 'resuelto',
                  foto_solucion: fotoGuardar,
                  usuario_resuelve: usuario,
                  usuario_resuelve_email: usuarioEmail,
                  fecha_resolucion: new Date()
                });

                alert('‚úÖ Reporte resuelto exitosamente');
                setVista('lista');
              } catch (error) {
                console.error('‚ùå Error al resolver reporte:', error);
                alert('Error al resolver: ' + error.message);
              } finally {
                setCargando(false);
              }
            };

            const handleEliminar = async () => {
              if (!esAdmin && !esGerente) { alert('Solo administradores y gerentes pueden eliminar reportes'); return; }
              if (!confirm('¬øEst√°s seguro de eliminar este reporte?')) return;
              try {
                // Borrar fotos de Storage si son URLs
                if (reporteActual.foto_problema && reporteActual.foto_problema.startsWith('http')) {
                  try { await storage.refFromURL(reporteActual.foto_problema).delete(); } catch(e) {}
                }
                if (reporteActual.foto_solucion && reporteActual.foto_solucion.startsWith('http')) {
                  try { await storage.refFromURL(reporteActual.foto_solucion).delete(); } catch(e) {}
                }
                await db.collection('reportes').doc(reporteActual.id).delete();
                alert('‚úÖ Reporte eliminado');
                setVista('lista');
              } catch (error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar reporte');
              }
            };

            const handleAgregarComentario = async () => {
              if (!nuevoComentario.trim()) return;
              try {
                const comentariosActuales = reporteActual.comentarios || [];
                await db.collection('reportes').doc(reporteActual.id).update({
                  comentarios: [...comentariosActuales, {
                    usuario: usuario,
                    texto: nuevoComentario.trim(),
                    fecha: new Date()
                  }]
                });
                setNuevoComentario('');
              } catch (error) {
                console.error('Error al agregar comentario:', error);
                alert('Error al agregar comentario');
              }
            };

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-blue-600 text-white p-6">
                  <button onClick={() => setVista('lista')} className="mb-4 text-blue-100 hover:text-white">‚Üê Volver</button>
                  <h1 className="text-2xl font-bold">Detalle del Reporte</h1>
                  {sucursal && <p className="text-blue-100 text-sm mt-1">üìç {sucursal.nombre}</p>}
                </div>

                <div className="p-6 space-y-6">
                  {/* Info principal */}
                  <div className="bg-white rounded-lg p-6 shadow">
                    <div className="flex items-center gap-3 mb-4">
                      <span className="text-3xl">{categoria?.icon}</span>
                      <div>
                        <div className="font-bold text-xl" style={{ color: categoria?.color }}>{categoria?.nombre}</div>
                        <div className="text-sm text-gray-500">Reportado por {reporteActual.usuario_reporta}</div>
                      </div>
                    </div>

                    <div className={`inline-block px-4 py-2 rounded-full font-medium mb-4 ${reporteActual.estado === 'abierto' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                      {reporteActual.estado === 'abierto' ? 'üî¥ Abierto' : '‚úÖ Resuelto'}
                    </div>

                    <p className="text-gray-700 mb-4">{reporteActual.descripcion}</p>
                    <div className="text-sm text-gray-500">Creado: {formatFecha(reporteActual.fecha_creacion)}</div>
                  </div>

                  {/* Foto del problema */}
                  <div className="bg-white rounded-lg p-6 shadow">
                    <h3 className="font-bold text-gray-800 mb-3">üì∑ Foto del Problema</h3>
                    {reporteActual.foto_problema ? (
                      <img src={reporteActual.foto_problema} alt="Problema" className="w-full rounded-lg" />
                    ) : (
                      <div className="text-gray-400 text-center py-8 bg-gray-50 rounded-lg">
                        <div className="text-3xl mb-2">üóëÔ∏è</div>
                        Foto eliminada por pol√≠tica de retenci√≥n ({DIAS_RETENCION} d√≠as)
                      </div>
                    )}
                  </div>

                  {/* Foto de la soluci√≥n (si est√° resuelto) */}
                  {reporteActual.estado === 'resuelto' && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h3 className="font-bold text-gray-800 mb-3">‚úÖ Foto de la Soluci√≥n</h3>
                      {reporteActual.foto_solucion ? (
                        <>
                          <img src={reporteActual.foto_solucion} alt="Soluci√≥n" className="w-full rounded-lg mb-3" />
                          <div className="text-sm text-gray-500">
                            Resuelto por {reporteActual.usuario_resuelve}<br />
                            {formatFecha(reporteActual.fecha_resolucion)}
                          </div>
                        </>
                      ) : (
                        <div className="text-gray-400 text-center py-8 bg-gray-50 rounded-lg">
                          <div className="text-3xl mb-2">üóëÔ∏è</div>
                          Foto eliminada por pol√≠tica de retenci√≥n ({DIAS_RETENCION} d√≠as)
                        </div>
                      )}
                    </div>
                  )}

                  {/* Resolver (si est√° abierto) */}
                  {reporteActual.estado === 'abierto' && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h3 className="font-bold text-gray-800 mb-3">Marcar como Resuelto</h3>
                      <input type="file" accept="image/*" onChange={handleFotoSolucionChange} className="hidden" id="foto-solucion-input" />
                      <label htmlFor="foto-solucion-input" className="block w-full p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-green-500 transition mb-4">
                        {previsualizacionSolucion ? (
                          <img src={previsualizacionSolucion} alt="Preview" className="max-h-48 mx-auto rounded" />
                        ) : (
                          <>
                            <div className="text-4xl mb-2">üì∑</div>
                            <div className="text-gray-600">Tocar para tomar foto de la soluci√≥n</div>
                          </>
                        )}
                      </label>
                      <button onClick={handleResolver} disabled={cargando || !fotoSolucion} className="w-full bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-300">
                        {cargando ? 'Resolviendo...' : '‚úÖ Marcar como Resuelto'}
                      </button>
                    </div>
                  )}

                  {/* Secci√≥n de Comentarios */}
                  <div className="bg-white rounded-lg p-6 shadow">
                    <h3 className="font-bold text-gray-800 mb-4">üí¨ Comentarios y Actualizaciones</h3>
                    
                    {/* Lista de comentarios */}
                    <div className="space-y-3 mb-4">
                      {reporteActual.comentarios && reporteActual.comentarios.length > 0 ? (
                        reporteActual.comentarios.map((comentario, index) => {
                          const fecha = getFecha(comentario.fecha);
                          return (
                            <div key={index} className="bg-gray-50 p-3 rounded-lg">
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-medium text-sm text-gray-900">{comentario.usuario}</span>
                                <span className="text-xs text-gray-500">
                                  {fecha && formatFecha(comentario.fecha)}
                                </span>
                              </div>
                              <p className="text-sm text-gray-700">{comentario.texto}</p>
                            </div>
                          );
                        })
                      ) : (
                        <p className="text-sm text-gray-500 italic">No hay comentarios a√∫n</p>
                      )}
                    </div>
                    
                    {/* Agregar nuevo comentario */}
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={nuevoComentario}
                        onChange={(e) => setNuevoComentario(e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter' && nuevoComentario.trim()) {
                            handleAgregarComentario();
                          }
                        }}
                        placeholder="Agregar actualizaci√≥n..."
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <button
                        onClick={handleAgregarComentario}
                        disabled={!nuevoComentario.trim()}
                        className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg font-medium transition"
                      >
                        Enviar
                      </button>
                    </div>
                  </div>

                  {/* Eliminar (admin o gerente) */}
                  {(esAdmin || esGerente) && (
                    <button onClick={handleEliminar} className="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition">üóëÔ∏è Eliminar Reporte</button>
                  )}
                </div>
              </div>
            );
          };

          // ========================================
          // DASHBOARD
          // ========================================
          const VistaDashboard = () => {
            // Estados para filtro de fechas
            const [filtroFecha, setFiltroFecha] = useState('todo'); // 'todo', 'semana', 'mes', 'mes_anterior', 'personalizado'
            const [fechaDesde, setFechaDesde] = useState('');
            const [fechaHasta, setFechaHasta] = useState('');

            // Funciones auxiliares de fechas
            const hoy = new Date();
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay());
            inicioSemana.setHours(0,0,0,0);

            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59);

            const inicioMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            const finMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0, 23, 59, 59);

            // Aplicar filtro de fechas
            const reportesFiltrados = reportes.filter(r => {
              if (filtroFecha === 'todo') return true;

              const fechaCreacion = getFecha(r.fecha_creacion);
              if (!fechaCreacion) return false;

              let desde, hasta;
              
              if (filtroFecha === 'semana') {
                desde = inicioSemana;
                hasta = hoy;
              } else if (filtroFecha === 'mes') {
                desde = inicioMes;
                hasta = finMes;
              } else if (filtroFecha === 'mes_anterior') {
                desde = inicioMesAnterior;
                hasta = finMesAnterior;
              } else if (filtroFecha === 'personalizado' && fechaDesde && fechaHasta) {
                desde = new Date(fechaDesde);
                hasta = new Date(fechaHasta);
                hasta.setHours(23, 59, 59);
              } else {
                return true;
              }

              return fechaCreacion >= desde && fechaCreacion <= hasta;
            });

            // Calcular estad√≠sticas con reportes filtrados
            const stats = {
              total: reportesFiltrados.length,
              abiertos: reportesFiltrados.filter(r => r.estado === 'abierto').length,
              resueltos: reportesFiltrados.filter(r => r.estado === 'resuelto').length,
              tasaResolucion: reportesFiltrados.length > 0 ? Math.round((reportesFiltrados.filter(r => r.estado === 'resuelto').length / reportesFiltrados.length) * 100) : 0
            };

            const statsPorSucursal = esAdmin && sucursalActiva === 'TODAS'
              ? SUCURSALES.map(suc => {
                  const rep = reportesFiltrados.filter(r => r.sucursal === suc.id);
                  const res = rep.filter(r => r.estado === 'resuelto').length;
                  return { ...suc, total: rep.length, abiertos: rep.filter(r => r.estado === 'abierto').length, resueltos: res, tasaResolucion: rep.length > 0 ? Math.round((res / rep.length) * 100) : 0 };
                }).filter(s => s.total > 0).sort((a, b) => b.total - a.total)
              : null;

            const porCategoria = CATEGORIAS.map(cat => {
              const rep = reportesFiltrados.filter(r => r.categoria === cat.id);
              return { ...cat, total: rep.length, abiertos: rep.filter(r => r.estado === 'abierto').length, resueltos: rep.filter(r => r.estado === 'resuelto').length };
            }).filter(cat => cat.total > 0);

            const usuariosStats = {};
            reportesFiltrados.forEach(r => {
              // Usar email como key para evitar duplicados
              const emailReporta = r.usuario_reporta_email || r.usuario_reporta;
              const nombreReporta = r.usuario_reporta;
              
              if (emailReporta) {
                if (!usuariosStats[emailReporta]) {
                  usuariosStats[emailReporta] = { nombre: nombreReporta, reportados: 0, resueltos: 0 };
                }
                usuariosStats[emailReporta].reportados++;
              }
              
              const emailResuelve = r.usuario_resuelve_email || r.usuario_resuelve;
              const nombreResuelve = r.usuario_resuelve;
              
              if (emailResuelve) {
                if (!usuariosStats[emailResuelve]) {
                  usuariosStats[emailResuelve] = { nombre: nombreResuelve, reportados: 0, resueltos: 0 };
                }
                usuariosStats[emailResuelve].resueltos++;
              }
            });

            const topReportadores = Object.entries(usuariosStats)
              .filter(([email, stats]) => stats.reportados > 0)
              .sort((a, b) => b[1].reportados - a[1].reportados)
              .slice(0, 5);

            const topResolvedores = Object.entries(usuariosStats)
              .filter(([email, stats]) => stats.resueltos > 0)
              .sort((a, b) => b[1].resueltos - a[1].resueltos)
              .slice(0, 5);

            // Texto descriptivo del per√≠odo
            const getTextoPeriodo = () => {
              if (filtroFecha === 'todo') return 'Todo el per√≠odo';
              if (filtroFecha === 'semana') return 'Esta semana';
              if (filtroFecha === 'mes') return 'Este mes';
              if (filtroFecha === 'mes_anterior') return 'Mes anterior';
              if (filtroFecha === 'personalizado' && fechaDesde && fechaHasta) {
                return `${new Date(fechaDesde).toLocaleDateString('es-AR')} - ${new Date(fechaHasta).toLocaleDateString('es-AR')}`;
              }
              return 'Seleccion√° per√≠odo';
            };

            return (
              <div className="min-h-screen bg-gray-50" id="dashboard-container">
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 no-print">
                  <div className="flex justify-between items-center mb-4">
                    <button onClick={() => setVista('lista')} className="text-blue-100 hover:text-white">‚Üê Volver</button>
                    <button 
                      onClick={() => window.print()} 
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition text-sm flex items-center gap-2"
                    >
                      üñ®Ô∏è Imprimir / Descargar PDF
                    </button>
                  </div>
                  <h1 className="text-2xl font-bold mb-2">üìä Dashboard</h1>
                  <p className="text-blue-100">{sucursalActiva === 'TODAS' ? 'Todas las Sucursales' : SUCURSALES.find(s => s.id === sucursalActiva)?.nombre}</p>
                </div>

                {/* Header para impresi√≥n */}
                <div className="print-only hidden">
                  <div className="text-center mb-6 pb-4 border-b-2 border-gray-300">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">FERNI - Dashboard de Incidencias</h1>
                    <p className="text-lg text-gray-600">{sucursalActiva === 'TODAS' ? 'Todas las Sucursales' : SUCURSALES.find(s => s.id === sucursalActiva)?.nombre}</p>
                    <p className="text-sm text-gray-500 mt-2">Per√≠odo: {getTextoPeriodo()}</p>
                    <p className="text-sm text-gray-500">Generado el {new Date().toLocaleDateString('es-AR', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' })}</p>
                  </div>
                </div>

                <div className="p-6 space-y-6">
                  {/* Filtro de fechas */}
                  <div className="bg-white rounded-lg p-4 shadow no-print">
                    <h3 className="font-bold text-gray-800 mb-3">üìÖ Filtrar por per√≠odo</h3>
                    
                    {/* Botones r√°pidos */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      <button onClick={() => setFiltroFecha('todo')} className={`px-4 py-2 rounded-lg font-medium transition ${filtroFecha === 'todo' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                        Todo
                      </button>
                      <button onClick={() => setFiltroFecha('semana')} className={`px-4 py-2 rounded-lg font-medium transition ${filtroFecha === 'semana' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                        Esta semana
                      </button>
                      <button onClick={() => setFiltroFecha('mes')} className={`px-4 py-2 rounded-lg font-medium transition ${filtroFecha === 'mes' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                        Este mes
                      </button>
                      <button onClick={() => setFiltroFecha('mes_anterior')} className={`px-4 py-2 rounded-lg font-medium transition ${filtroFecha === 'mes_anterior' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                        Mes anterior
                      </button>
                      <button onClick={() => setFiltroFecha('personalizado')} className={`px-4 py-2 rounded-lg font-medium transition ${filtroFecha === 'personalizado' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                        Personalizado
                      </button>
                    </div>

                    {/* Date pickers (solo si es personalizado) */}
                    {filtroFecha === 'personalizado' && (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                          <input 
                            type="date" 
                            value={fechaDesde} 
                            onChange={(e) => setFechaDesde(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                          <input 
                            type="date" 
                            value={fechaHasta} 
                            onChange={(e) => setFechaHasta(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                          />
                        </div>
                      </div>
                    )}

                    <div className="mt-3 text-sm text-gray-600">
                      üìå Mostrando: <span className="font-semibold">{getTextoPeriodo()}</span> ({reportesFiltrados.length} reportes)
                    </div>
                  </div>

                  {/* Estad√≠sticas principales */}
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white rounded-lg p-4 shadow"><div className="text-3xl font-bold text-blue-600">{stats.total}</div><div className="text-sm text-gray-600">Total Reportes</div></div>
                    <div className="bg-white rounded-lg p-4 shadow"><div className="text-3xl font-bold text-red-600">{stats.abiertos}</div><div className="text-sm text-gray-600">Abiertos</div></div>
                    <div className="bg-white rounded-lg p-4 shadow"><div className="text-3xl font-bold text-green-600">{stats.resueltos}</div><div className="text-sm text-gray-600">Resueltos</div></div>
                    <div className="bg-white rounded-lg p-4 shadow"><div className="text-3xl font-bold text-purple-600">{stats.tasaResolucion}%</div><div className="text-sm text-gray-600">Tasa Resoluci√≥n</div></div>
                  </div>

                  {statsPorSucursal && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">Por Sucursal</h2>
                      <div className="space-y-3">
                        {statsPorSucursal.map(suc => (
                          <div key={suc.id} className="border-b border-gray-100 pb-3 last:border-0">
                            <div className="flex justify-between items-center mb-1">
                              <div className="font-semibold text-gray-800">{suc.nombre}</div>
                              <div className="flex items-center gap-3">
                                <span className="text-sm text-gray-600">{suc.total} reportes</span>
                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${suc.tasaResolucion >= 80 ? 'bg-green-100 text-green-700' : suc.tasaResolucion >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>{suc.tasaResolucion}%</span>
                              </div>
                            </div>
                            <div className="flex gap-4 text-xs">
                              <span className="text-red-600">{suc.abiertos} abiertos</span>
                              <span className="text-green-600">{suc.resueltos} resueltos</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="bg-white rounded-lg p-6 shadow">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Por Categor√≠a</h2>
                    <div className="space-y-4">
                      {porCategoria.map(cat => (
                        <div key={cat.id}>
                          <div className="flex justify-between items-center mb-1">
                            <div className="flex items-center gap-2">
                              <span className="text-xl">{cat.icon}</span>
                              <span className="font-semibold text-gray-900">{cat.nombre}</span>
                            </div>
                            <span className="font-bold text-xl" style={{ color: cat.color }}>{cat.total}</span>
                          </div>
                          <div className="flex justify-end gap-4 text-xs">
                            <span className="text-red-600 font-medium">{cat.abiertos} abiertos</span>
                            <span className="text-green-600 font-medium">{cat.resueltos} resueltos</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Gr√°fico de categor√≠as */}
                  {porCategoria.length > 0 && (
                    <div className="bg-white rounded-lg p-6 shadow no-print">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">üìä Incidencias por Categor√≠a</h2>
                      <canvas ref={el => {
                        if (el && porCategoria.length > 0) {
                          const ctx = el.getContext('2d');
                          // Destruir gr√°fico anterior si existe
                          if (el.chart) {
                            el.chart.destroy();
                          }
                          // Crear nuevo gr√°fico
                          el.chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                              labels: porCategoria.map(c => c.icon + ' ' + c.nombre),
                              datasets: [
                                {
                                  label: 'Abiertos',
                                  data: porCategoria.map(c => c.abiertos),
                                  backgroundColor: '#EF4444',
                                  borderRadius: 4
                                },
                                {
                                  label: 'Resueltos',
                                  data: porCategoria.map(c => c.resueltos),
                                  backgroundColor: '#10B981',
                                  borderRadius: 4
                                }
                              ]
                            },
                            options: {
                              responsive: true,
                              maintainAspectRatio: true,
                              aspectRatio: 1.5,
                              plugins: {
                                legend: {
                                  position: 'top',
                                }
                              },
                              scales: {
                                x: {
                                  stacked: false,
                                },
                                y: {
                                  stacked: false,
                                  beginAtZero: true,
                                  ticks: {
                                    stepSize: 1
                                  }
                                }
                              }
                            }
                          });
                        }
                      }} />
                    </div>
                  )}

                  {topReportadores.length > 0 && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">üèÜ Top Reportadores</h2>
                      <div className="space-y-3">
                        {topReportadores.map(([email, stats], idx) => (
                          <div key={email} className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${idx === 0 ? 'bg-yellow-400 text-yellow-900' : idx === 1 ? 'bg-gray-300 text-gray-700' : idx === 2 ? 'bg-orange-400 text-orange-900' : 'bg-gray-100 text-gray-600'}`}>{idx + 1}</div>
                              <span className="font-medium text-gray-800">{stats.nombre}</span>
                            </div>
                            <span className="font-bold text-blue-600">{stats.reportados}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {topResolvedores.length > 0 && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">‚ö° Top Resolvedores</h2>
                      <div className="space-y-3">
                        {topResolvedores.map(([email, stats], idx) => (
                          <div key={email} className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${idx === 0 ? 'bg-yellow-400 text-yellow-900' : idx === 1 ? 'bg-gray-300 text-gray-700' : idx === 2 ? 'bg-orange-400 text-orange-900' : 'bg-gray-100 text-gray-600'}`}>{idx + 1}</div>
                              <span className="font-medium text-gray-800">{stats.nombre}</span>
                            </div>
                            <span className="font-bold text-green-600">{stats.resueltos}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {(esAdmin || esGerente) && (
                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                      <div className="flex gap-3">
                        <div className="text-2xl">üßπ</div>
                        <div>
                          <div className="font-semibold text-blue-900">Limpieza Autom√°tica Activa</div>
                          <div className="text-sm text-blue-700">Las fotos de reportes resueltos se eliminan autom√°ticamente despu√©s de {DIAS_RETENCION} d√≠as.</div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* An√°lisis Inteligente - Solo admin y gerentes */}
                  {(esAdmin || esGerente) && (() => {
                    const generarAnalisis = () => {
                      if (reportesFiltrados.length === 0) return null;

                      const totalR = reportesFiltrados.length;
                      const abiertosR = reportesFiltrados.filter(r => r.estado === 'abierto');
                      const resueltosR = reportesFiltrados.filter(r => r.estado === 'resuelto');
                      const tasaRes = totalR > 0 ? Math.round((resueltosR.length / totalR) * 100) : 0;

                      // Categor√≠a m√°s problem√°tica (m√°s abiertos)
                      const catAbiertos = {};
                      abiertosR.forEach(r => { catAbiertos[r.categoria] = (catAbiertos[r.categoria] || 0) + 1; });
                      const catCriticaId = Object.entries(catAbiertos).sort((a, b) => b[1] - a[1])[0];
                      const catCritica = catCriticaId ? CATEGORIAS.find(c => c.id === catCriticaId[0]) : null;

                      // Categor√≠a con peor tasa de resoluci√≥n
                      const catTasas = CATEGORIAS.map(cat => {
                        const rep = reportesFiltrados.filter(r => r.categoria === cat.id);
                        const res = rep.filter(r => r.estado === 'resuelto').length;
                        return { ...cat, total: rep.length, resueltos: res, tasa: rep.length > 0 ? Math.round((res / rep.length) * 100) : 100 };
                      }).filter(c => c.total >= 2).sort((a, b) => a.tasa - b.tasa);
                      const peorCategoria = catTasas.length > 0 ? catTasas[0] : null;

                      // Tiempo promedio de resoluci√≥n
                      const tiempos = resueltosR.map(r => {
                        const fc = getFecha(r.fecha_creacion);
                        const fr = getFecha(r.fecha_resolucion);
                        if (fc && fr) return (fr - fc) / (1000 * 60 * 60);
                        return null;
                      }).filter(t => t !== null && t >= 0);
                      const tiempoPromedio = tiempos.length > 0 ? Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length) : null;

                      // Empleados destacados
                      const resolvedoresCount = {};
                      resueltosR.forEach(r => {
                        const key = r.usuario_resuelve_email || r.usuario_resuelve;
                        const name = r.usuario_resuelve;
                        if (key && name) {
                          if (!resolvedoresCount[key]) resolvedoresCount[key] = { nombre: name, count: 0 };
                          resolvedoresCount[key].count++;
                        }
                      });
                      const topResolvedor = Object.values(resolvedoresCount).sort((a, b) => b.count - a.count)[0];

                      // Tendencia: comparar primera mitad vs segunda mitad
                      const mitad = Math.floor(reportesFiltrados.length / 2);
                      const primeraM = reportesFiltrados.slice(mitad); // m√°s viejos (por sort desc)
                      const segundaM = reportesFiltrados.slice(0, mitad); // m√°s recientes
                      const tasaPrimera = primeraM.length > 0 ? primeraM.filter(r => r.estado === 'resuelto').length / primeraM.length : 0;
                      const tasaSegunda = segundaM.length > 0 ? segundaM.filter(r => r.estado === 'resuelto').length / segundaM.length : 0;
                      const tendencia = tasaSegunda > tasaPrimera + 0.05 ? 'mejorando' : tasaSegunda < tasaPrimera - 0.05 ? 'empeorando' : 'estable';

                      // Sucursal m√°s cr√≠tica (solo para admin viendo todas)
                      let sucCritica = null;
                      if (esAdmin && sucursalActiva === 'TODAS') {
                        const sucStats = SUCURSALES.map(suc => {
                          const rep = reportesFiltrados.filter(r => r.sucursal === suc.id);
                          const ab = rep.filter(r => r.estado === 'abierto').length;
                          return { ...suc, abiertos: ab, total: rep.length };
                        }).filter(s => s.total > 0).sort((a, b) => b.abiertos - a.abiertos);
                        sucCritica = sucStats.length > 0 && sucStats[0].abiertos > 0 ? sucStats[0] : null;
                      }

                      // Generar recomendaciones
                      const recomendaciones = [];
                      
                      if (tasaRes < 60) {
                        recomendaciones.push({ tipo: 'alerta', texto: `La tasa de resoluci√≥n es del ${tasaRes}%. Objetivo recomendado: 80%+. Considerar asignar responsables fijos por categor√≠a.` });
                      } else if (tasaRes >= 80) {
                        recomendaciones.push({ tipo: 'exito', texto: `Excelente tasa de resoluci√≥n del ${tasaRes}%. El equipo est√° respondiendo bien a las incidencias.` });
                      } else {
                        recomendaciones.push({ tipo: 'atencion', texto: `Tasa de resoluci√≥n del ${tasaRes}%. Hay margen de mejora, el objetivo ideal es superar el 80%.` });
                      }

                      if (catCritica && catCriticaId[1] >= 3) {
                        recomendaciones.push({ tipo: 'alerta', texto: `"${catCritica.icon} ${catCritica.nombre}" tiene ${catCriticaId[1]} incidencias abiertas. Recomendaci√≥n: priorizar esta categor√≠a esta semana.` });
                      }

                      if (peorCategoria && peorCategoria.tasa < 50) {
                        recomendaciones.push({ tipo: 'atencion', texto: `"${peorCategoria.icon} ${peorCategoria.nombre}" tiene la tasa m√°s baja (${peorCategoria.tasa}%). Revisar si hay bloqueos o falta de recursos.` });
                      }

                      if (tiempoPromedio !== null) {
                        if (tiempoPromedio > 72) {
                          recomendaciones.push({ tipo: 'alerta', texto: `Tiempo promedio de resoluci√≥n: ${tiempoPromedio}hs (~${Math.round(tiempoPromedio/24)} d√≠as). Es alto. Definir SLAs por categor√≠a puede mejorar esto.` });
                        } else if (tiempoPromedio <= 24) {
                          recomendaciones.push({ tipo: 'exito', texto: `Tiempo promedio de resoluci√≥n: ${tiempoPromedio}hs. Respuesta r√°pida del equipo.` });
                        } else {
                          recomendaciones.push({ tipo: 'atencion', texto: `Tiempo promedio de resoluci√≥n: ${tiempoPromedio}hs (~${Math.round(tiempoPromedio/24)} d√≠as). Aceptable, pero se puede mejorar.` });
                        }
                      }

                      if (topResolvedor) {
                        recomendaciones.push({ tipo: 'exito', texto: `${topResolvedor.nombre} lidera las resoluciones con ${topResolvedor.count} problemas resueltos. Reconocer su compromiso.` });
                      }

                      if (tendencia === 'mejorando') {
                        recomendaciones.push({ tipo: 'exito', texto: 'Tendencia positiva: la tasa de resoluci√≥n viene mejorando en el per√≠odo reciente.' });
                      } else if (tendencia === 'empeorando') {
                        recomendaciones.push({ tipo: 'alerta', texto: 'Tendencia negativa: la tasa de resoluci√≥n viene bajando. Revisar carga de trabajo y recursos.' });
                      }

                      if (sucCritica && sucCritica.abiertos >= 3) {
                        recomendaciones.push({ tipo: 'atencion', texto: `${sucCritica.nombre} tiene ${sucCritica.abiertos} incidencias abiertas, m√°s que otras sucursales. Requiere atenci√≥n.` });
                      }

                      if (abiertosR.length === 0 && totalR > 0) {
                        recomendaciones.push({ tipo: 'exito', texto: '¬°No hay incidencias abiertas! Todas resueltas. Excelente trabajo del equipo.' });
                      }

                      return recomendaciones;
                    };

                    const [mostrarAnalisis, setMostrarAnalisis] = useState(false);
                    const analisis = mostrarAnalisis ? generarAnalisis() : null;

                    return (
                      <div className="bg-white rounded-lg p-6 shadow">
                        <button 
                          onClick={() => setMostrarAnalisis(!mostrarAnalisis)}
                          className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition flex items-center justify-center gap-3 text-lg"
                        >
                          <span className="text-2xl">üß†</span>
                          {mostrarAnalisis ? 'Ocultar An√°lisis' : 'Generar An√°lisis Inteligente'}
                        </button>
                        
                        {mostrarAnalisis && analisis && analisis.length > 0 && (
                          <div className="mt-6 space-y-3">
                            <h3 className="font-bold text-gray-800 text-lg mb-4">üìã Informe de Situaci√≥n</h3>
                            {analisis.map((item, idx) => (
                              <div key={idx} className={`p-4 rounded-lg border-l-4 ${
                                item.tipo === 'alerta' ? 'bg-red-50 border-red-500' :
                                item.tipo === 'atencion' ? 'bg-yellow-50 border-yellow-500' :
                                'bg-green-50 border-green-500'
                              }`}>
                                <div className="flex items-start gap-3">
                                  <span className="text-xl mt-0.5">
                                    {item.tipo === 'alerta' ? 'üî¥' : item.tipo === 'atencion' ? 'üü°' : 'üü¢'}
                                  </span>
                                  <p className={`text-sm font-medium ${
                                    item.tipo === 'alerta' ? 'text-red-800' :
                                    item.tipo === 'atencion' ? 'text-yellow-800' :
                                    'text-green-800'
                                  }`}>{item.texto}</p>
                                </div>
                              </div>
                            ))}
                            <div className="text-xs text-gray-400 mt-4 text-center">
                              An√°lisis generado sobre {reportesFiltrados.length} reportes ‚Ä¢ {getTextoPeriodo()}
                            </div>
                          </div>
                        )}
                        
                        {mostrarAnalisis && (!analisis || analisis.length === 0) && (
                          <div className="mt-4 text-center text-gray-500 py-4">
                            No hay suficientes datos para generar an√°lisis en este per√≠odo.
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              </div>
            );
          };

          return (
            <div>
              {vista === 'login' && <VistaLogin />}
              {vista === 'lista' && <VistaLista />}
              {vista === 'crear' && <VistaCrear />}
              {vista === 'detalle' && <VistaDetalle />}
              {vista === 'dashboard' && <VistaDashboard />}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FerniApp />);
    </script>

    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Estilos para impresi√≥n */
        @media print {
            /* Ocultar elementos de navegaci√≥n */
            .no-print {
                display: none !important;
            }

            /* Mostrar header especial para impresi√≥n */
            .print-only {
                display: block !important;
            }

            /* Optimizar p√°gina */
            body {
                background: white !important;
            }

            #dashboard-container {
                background: white !important;
                min-height: auto !important;
            }

            /* Evitar saltos de p√°gina dentro de elementos */
            .bg-white {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Ajustar m√°rgenes y padding para impresi√≥n */
            .p-6 {
                padding: 1rem !important;
            }

            /* Asegurar que los colores se impriman */
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Ajustar tama√±os de fuente para papel */
            .text-3xl {
                font-size: 1.5rem !important;
            }

            .text-2xl {
                font-size: 1.25rem !important;
            }

            .text-xl {
                font-size: 1.1rem !important;
            }

            /* Agregar bordes sutiles para mejor legibilidad */
            .shadow {
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
            }
        }
    </style>
</body>
</html>
