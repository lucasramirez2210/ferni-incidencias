<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1E3A5F">
    <title>FERNI - Sistema de Incidencias</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ========================================
        // CONFIGURACI√ìN FIREBASE
        // ========================================
        const firebaseConfig = {
          apiKey: "AIzaSyASCknH-hS84WKM4sGFehfVraXKm6T-ob0",
          authDomain: "ferni-incidencias.firebaseapp.com",
          projectId: "ferni-incidencias",
          storageBucket: "ferni-incidencias.firebasestorage.app",
          messagingSenderId: "744424538106",
          appId: "1:744424538106:web:8392fbe4f3e8c9b5e7c8d9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ========================================
        // CONFIGURACI√ìN
        // ========================================
        const DIAS_RETENCION = 90;
        
        // Credenciales de administradores
        const ADMINS = [
          { nombre: 'Lucas', email: 'lucas.ramirez2210@gmail.com', password: 'ferni2025' },
          { nombre: 'Gast√≥n Rivero', email: 'gastonrivero043@gmail.com', password: 'ferni2025' }
        ];
        
        // Las 9 sucursales
        const SUCURSALES = [
          { id: 'F1', nombre: 'FERNI 1' },
          { id: 'F2', nombre: 'FERNI 2' },
          { id: 'F3', nombre: 'FERNI 3' },
          { id: 'F4', nombre: 'FERNI 4' },
          { id: 'F5', nombre: 'FERNI 5' },
          { id: 'F6', nombre: 'FERNI 6' },
          { id: 'F7', nombre: 'FERNI 7' },
          { id: 'F8', nombre: 'FERNI 8' },
          { id: 'F9', nombre: 'FERNI 9' }
        ];

        const CATEGORIAS = [
          { id: 'visual', nombre: 'Visual Merchandising', color: '#FF6B35', icon: 'üè™' },
          { id: 'limpieza', nombre: 'Limpieza y Orden', color: '#4ECDC4', icon: 'üßπ' },
          { id: 'mantenimiento', nombre: 'Mantenimiento', color: '#FFA07A', icon: 'üîß' },
          { id: 'inventario', nombre: 'Inventario', color: '#9B59B6', icon: 'üì¶' },
          { id: 'ambiental', nombre: 'Mejoras Ambientales', color: '#27AE60', icon: '‚ôªÔ∏è' }
        ];

        // ========================================
        // FUNCI√ìN: MIGRAR REPORTES SIN SUCURSAL
        // ========================================
        const migrarReportesSinSucursal = async () => {
          try {
            console.log('üîÑ Verificando reportes sin sucursal...');
            
            const snapshot = await db.collection('reportes')
              .where('sucursal', '==', null)
              .get();
            
            if (snapshot.empty) {
              console.log('‚úÖ No hay reportes sin sucursal');
              return;
            }
            
            console.log(`üìã Encontrados ${snapshot.size} reportes sin sucursal, asignando a FERNI 7...`);
            
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
              batch.update(doc.ref, { sucursal: 'F7' });
            });
            
            await batch.commit();
            console.log(`‚úÖ ${snapshot.size} reportes migrados a FERNI 7`);
            
          } catch (error) {
            console.error('‚ùå Error en migraci√≥n:', error);
          }
        };

        // ========================================
        // FUNCI√ìN: COMPRIMIR FOTO
        // ========================================
        const comprimirFoto = (file, maxWidth = 800, quality = 0.7) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
              const img = new Image();
              
              img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                  height = (height * maxWidth) / width;
                  width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(
                  (blob) => {
                    if (blob) {
                      const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                      });
                      
                      console.log(`‚úÖ Foto comprimida: ${(file.size / 1024).toFixed(0)}KB ‚Üí ${(blob.size / 1024).toFixed(0)}KB`);
                      resolve(compressedFile);
                    } else {
                      reject(new Error('Error al comprimir imagen'));
                    }
                  },
                  'image/jpeg',
                  quality
                );
              };
              
              img.onerror = () => reject(new Error('Error al cargar imagen'));
              img.src = e.target.result;
            };
            
            reader.onerror = () => reject(new Error('Error al leer archivo'));
            reader.readAsDataURL(file);
          });
        };

        // ========================================
        // FUNCI√ìN: LIMPIAR FOTOS VIEJAS
        // ========================================
        const limpiarFotosViejas = async () => {
          try {
            console.log('üßπ Iniciando limpieza de fotos antiguas...');
            
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - DIAS_RETENCION);
            
            const snapshot = await db.collection('reportes')
              .where('estado', '==', 'resuelto')
              .where('fechaCreacion', '<', fechaLimite)
              .get();
            
            let fotosEliminadas = 0;
            let errores = 0;
            
            for (const doc of snapshot.docs) {
              const reporte = doc.data();
              
              if (reporte.fotoProblema) {
                try {
                  const refProblema = storage.refFromURL(reporte.fotoProblema);
                  await refProblema.delete();
                  fotosEliminadas++;
                } catch (err) {
                  console.warn('‚ö†Ô∏è Error al eliminar foto problema:', err);
                  errores++;
                }
              }
              
              if (reporte.fotoSolucion) {
                try {
                  const refSolucion = storage.refFromURL(reporte.fotoSolucion);
                  await refSolucion.delete();
                  fotosEliminadas++;
                } catch (err) {
                  console.warn('‚ö†Ô∏è Error al eliminar foto soluci√≥n:', err);
                  errores++;
                }
              }
              
              await doc.ref.update({
                fotoProblema: null,
                fotoSolucion: null,
                fotosEliminadasPorRetencion: true,
                fechaEliminacionFotos: new Date()
              });
            }
            
            console.log(`‚úÖ Limpieza completada: ${fotosEliminadas} fotos eliminadas, ${errores} errores`);
            return { fotosEliminadas, errores, reportesProcesados: snapshot.size };
            
          } catch (error) {
            console.error('‚ùå Error en limpieza autom√°tica:', error);
            return { fotosEliminadas: 0, errores: 1, reportesProcesados: 0 };
          }
        };

        // ========================================
        // COMPONENTE PRINCIPAL
        // ========================================
        function FerniApp() {
          const [vista, setVista] = useState('login');
          const [usuario, setUsuario] = useState(null);
          const [sucursalUsuario, setSucursalUsuario] = useState(null);
          const [sucursalActiva, setSucursalActiva] = useState(null);
          const [esAdmin, setEsAdmin] = useState(false);
          const [reportes, setReportes] = useState([]);
          const [filtroEstado, setFiltroEstado] = useState('todos');
          const [reporteActual, setReporteActual] = useState(null);
          const [cargando, setCargando] = useState(false);

          // Migrar reportes sin sucursal al cargar (solo una vez)
          useEffect(() => {
            const migrado = localStorage.getItem('reportes_migrados');
            if (!migrado) {
              migrarReportesSinSucursal().then(() => {
                localStorage.setItem('reportes_migrados', 'true');
              });
            }
          }, []);

          // Ejecutar limpieza autom√°tica (solo admins)
          useEffect(() => {
            if (esAdmin) {
              limpiarFotosViejas();
              const intervalo = setInterval(limpiarFotosViejas, 24 * 60 * 60 * 1000);
              return () => clearInterval(intervalo);
            }
          }, [esAdmin]);

          // Cargar reportes filtrados por sucursal
          useEffect(() => {
            if (!usuario || !sucursalActiva) return;

            let query = db.collection('reportes').orderBy('fechaCreacion', 'desc');
            
            // Si no es admin o eligi√≥ una sucursal espec√≠fica, filtrar
            if (sucursalActiva !== 'TODAS') {
              query = query.where('sucursal', '==', sucursalActiva);
            }

            const unsubscribe = query.onSnapshot((snapshot) => {
              const reportesData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setReportes(reportesData);
            });

            return () => unsubscribe();
          }, [usuario, sucursalActiva]);

          // ========================================
          // VISTA: LOGIN
          // ========================================
          const VistaLogin = () => {
            const [tipoLogin, setTipoLogin] = useState('empleado'); // 'empleado' o 'admin'
            
            // Empleado
            const [nombre, setNombre] = useState('');
            const [sucursal, setSucursal] = useState('');
            
            // Admin
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleLoginEmpleado = () => {
              if (!nombre.trim() || !sucursal) {
                alert('Por favor complet√° nombre y sucursal');
                return;
              }

              setUsuario(nombre.trim());
              setSucursalUsuario(sucursal);
              setSucursalActiva(sucursal);
              setEsAdmin(false);
              setVista('lista');
            };

            const handleLoginAdmin = () => {
              if (!email.trim() || !password.trim()) {
                alert('Por favor complet√° email y contrase√±a');
                return;
              }

              const admin = ADMINS.find(a => a.email === email && a.password === password);
              
              if (!admin) {
                alert('‚ùå Email o contrase√±a incorrectos');
                return;
              }

              setUsuario(admin.nombre);
              setSucursalUsuario('TODAS');
              setSucursalActiva('TODAS');
              setEsAdmin(true);
              setVista('lista');
            };

            return (
              <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                  <div className="text-center mb-8">
                    <div className="text-6xl mb-4">üè™</div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">FERNI</h1>
                    <p className="text-gray-600">Sistema de Incidencias</p>
                  </div>
                  
                  {/* Selector de tipo de login */}
                  <div className="flex gap-2 mb-6">
                    <button
                      onClick={() => setTipoLogin('empleado')}
                      className={`flex-1 py-3 rounded-lg font-semibold transition ${
                        tipoLogin === 'empleado'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üë§ Empleado
                    </button>
                    <button
                      onClick={() => setTipoLogin('admin')}
                      className={`flex-1 py-3 rounded-lg font-semibold transition ${
                        tipoLogin === 'admin'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üëë Admin
                    </button>
                  </div>

                  {/* Login Empleado */}
                  {tipoLogin === 'empleado' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Tu nombre
                        </label>
                        <input
                          type="text"
                          placeholder="Nombre y Apellido"
                          value={nombre}
                          onChange={(e) => setNombre(e.target.value)}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Tu sucursal
                        </label>
                        <select
                          value={sucursal}
                          onChange={(e) => setSucursal(e.target.value)}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-white"
                        >
                          <option value="">Seleccion√° tu tienda</option>
                          {SUCURSALES.map(s => (
                            <option key={s.id} value={s.id}>{s.nombre}</option>
                          ))}
                        </select>
                      </div>
                      
                      <button
                        onClick={handleLoginEmpleado}
                        className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                      >
                        Ingresar
                      </button>
                    </div>
                  )}

                  {/* Login Admin */}
                  {tipoLogin === 'admin' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Email
                        </label>
                        <input
                          type="email"
                          placeholder="admin@ferni.com"
                          value={email}
                          onChange={(e) => setEmail(e.target.value)}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Contrase√±a
                        </label>
                        <input
                          type="password"
                          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                          value={password}
                          onChange={(e) => setPassword(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleLoginAdmin()}
                          className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        />
                      </div>
                      
                      <button
                        onClick={handleLoginAdmin}
                        className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                      >
                        Ingresar como Admin
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          };

          // ========================================
          // VISTA: LISTA DE REPORTES
          // ========================================
          const VistaLista = () => {
            const reportesFiltrados = reportes.filter(r => 
              filtroEstado === 'todos' || r.estado === filtroEstado
            );

            const sucursalNombre = sucursalActiva === 'TODAS' 
              ? 'Todas las Sucursales' 
              : SUCURSALES.find(s => s.id === sucursalActiva)?.nombre || sucursalActiva;

            return (
              <div className="min-h-screen bg-gray-50">
                {/* Header */}
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 shadow-lg">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex-1">
                      <h1 className="text-2xl font-bold mb-1">FERNI Incidencias</h1>
                      <p className="text-blue-100 text-sm">
                        Hola, {usuario} {esAdmin && 'üëë'}
                      </p>
                      
                      {/* Selector de sucursal (solo admins) */}
                      {esAdmin && (
                        <div className="mt-3">
                          <select
                            value={sucursalActiva}
                            onChange={(e) => setSucursalActiva(e.target.value)}
                            className="px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30 text-sm font-medium focus:outline-none focus:bg-white/30"
                          >
                            <option value="TODAS">üìä Todas las sucursales</option>
                            {SUCURSALES.map(s => (
                              <option key={s.id} value={s.id}>üè™ {s.nombre}</option>
                            ))}
                          </select>
                        </div>
                      )}
                      
                      {!esAdmin && (
                        <div className="mt-2 text-blue-100 text-sm">
                          üìç {sucursalNombre}
                        </div>
                      )}
                    </div>
                    
                    <button
                      onClick={() => setVista('dashboard')}
                      className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition text-sm"
                    >
                      üìä Dashboard
                    </button>
                  </div>
                  
                  {/* Stats */}
                  <div className="grid grid-cols-3 gap-3">
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.length}</div>
                      <div className="text-xs text-blue-100">Total</div>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.filter(r => r.estado === 'abierto').length}</div>
                      <div className="text-xs text-blue-100">Abiertos</div>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold">{reportes.filter(r => r.estado === 'resuelto').length}</div>
                      <div className="text-xs text-blue-100">Resueltos</div>
                    </div>
                  </div>
                </div>

                {/* Filtros */}
                <div className="p-4 bg-white border-b flex gap-2 overflow-x-auto">
                  {['todos', 'abierto', 'resuelto'].map(estado => (
                    <button
                      key={estado}
                      onClick={() => setFiltroEstado(estado)}
                      className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap transition ${
                        filtroEstado === estado
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {estado === 'todos' ? 'üìã Todos' : estado === 'abierto' ? 'üî¥ Abiertos' : '‚úÖ Resueltos'}
                    </button>
                  ))}
                </div>

                {/* Lista de reportes */}
                <div className="p-4 space-y-3 pb-24">
                  {reportesFiltrados.length === 0 ? (
                    <div className="text-center py-12 text-gray-400">
                      <div className="text-6xl mb-4">üì≠</div>
                      <p>No hay reportes</p>
                    </div>
                  ) : (
                    reportesFiltrados.map(reporte => {
                      const categoria = CATEGORIAS.find(c => c.id === reporte.categoria);
                      const sucursal = SUCURSALES.find(s => s.id === reporte.sucursal);
                      
                      return (
                        <div
                          key={reporte.id}
                          onClick={() => {
                            setReporteActual(reporte);
                            setVista('detalle');
                          }}
                          className="bg-white rounded-lg p-4 shadow hover:shadow-md transition cursor-pointer"
                          style={{ borderLeft: `4px solid ${categoria?.color}` }}
                        >
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex items-center gap-2 flex-1">
                              <span className="text-2xl">{categoria?.icon}</span>
                              <div className="flex-1">
                                <div className="font-semibold text-gray-800">{categoria?.nombre}</div>
                                <div className="text-sm text-gray-500">
                                  Por {reporte.reportadoPor}
                                  {sucursalActiva === 'TODAS' && sucursal && (
                                    <span className="ml-2 text-blue-600">‚Ä¢ {sucursal.nombre}</span>
                                  )}
                                </div>
                              </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
                              reporte.estado === 'abierto'
                                ? 'bg-red-100 text-red-700'
                                : 'bg-green-100 text-green-700'
                            }`}>
                              {reporte.estado === 'abierto' ? 'üî¥ Abierto' : '‚úÖ Resuelto'}
                            </span>
                          </div>
                          
                          <p className="text-gray-600 text-sm mb-2 line-clamp-2">{reporte.descripcion}</p>
                          
                          <div className="text-xs text-gray-400">
                            {new Date(reporte.fechaCreacion?.toDate()).toLocaleDateString('es-AR', {
                              day: '2-digit',
                              month: '2-digit',
                              year: 'numeric',
                              hour: '2-digit',
                              minute: '2-digit'
                            })}
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>

                {/* Bot√≥n flotante crear */}
                <button
                  onClick={() => setVista('crear')}
                  className="fixed bottom-6 right-6 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg hover:bg-blue-700 transition flex items-center justify-center text-3xl"
                >
                  +
                </button>
              </div>
            );
          };

          // ========================================
          // VISTA: CREAR REPORTE
          // ========================================
          const VistaCrear = () => {
            const [categoria, setCategoria] = useState('');
            const [descripcion, setDescripcion] = useState('');
            const [foto, setFoto] = useState(null);
            const [previsualizacion, setPrevisualizacion] = useState(null);

            const handleFotoChange = async (e) => {
              const file = e.target.files[0];
              if (file) {
                try {
                  const fotoComprimida = await comprimirFoto(file);
                  setFoto(fotoComprimida);
                  
                  const reader = new FileReader();
                  reader.onload = (e) => setPrevisualizacion(e.target.result);
                  reader.readAsDataURL(fotoComprimida);
                } catch (error) {
                  console.error('Error al comprimir foto:', error);
                  alert('Error al procesar la foto');
                }
              }
            };

            const handleCrear = async () => {
              if (!categoria || !descripcion || !foto) {
                alert('Por favor complet√° todos los campos');
                return;
              }

              setCargando(true);

              try {
                const storageRef = storage.ref(`reportes/${Date.now()}_${foto.name}`);
                await storageRef.put(foto);
                const fotoURL = await storageRef.getDownloadURL();

                await db.collection('reportes').add({
                  categoria,
                  descripcion,
                  fotoProblema: fotoURL,
                  reportadoPor: usuario,
                  estado: 'abierto',
                  fechaCreacion: new Date(),
                  sucursal: esAdmin && sucursalActiva !== 'TODAS' ? sucursalActiva : sucursalUsuario
                });

                alert('‚úÖ Reporte creado exitosamente');
                setVista('lista');
              } catch (error) {
                console.error('Error al crear reporte:', error);
                alert('Error al crear reporte');
              } finally {
                setCargando(false);
              }
            };

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-blue-600 text-white p-6">
                  <button
                    onClick={() => setVista('lista')}
                    className="mb-4 text-blue-100 hover:text-white"
                  >
                    ‚Üê Volver
                  </button>
                  <h1 className="text-2xl font-bold">Nuevo Reporte</h1>
                  <p className="text-blue-100 text-sm mt-1">
                    {esAdmin && sucursalActiva !== 'TODAS' 
                      ? SUCURSALES.find(s => s.id === sucursalActiva)?.nombre
                      : SUCURSALES.find(s => s.id === sucursalUsuario)?.nombre
                    }
                  </p>
                </div>

                <div className="p-6 space-y-6">
                  <div>
                    <label className="block text-gray-700 font-semibold mb-3">Categor√≠a</label>
                    <div className="grid grid-cols-1 gap-3">
                      {CATEGORIAS.map(cat => (
                        <button
                          key={cat.id}
                          onClick={() => setCategoria(cat.id)}
                          className={`p-4 rounded-lg border-2 transition text-left ${
                            categoria === cat.id
                              ? 'border-blue-500 bg-blue-50'
                              : 'border-gray-200 bg-white hover:border-gray-300'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">{cat.icon}</span>
                            <span className="font-medium" style={{ color: cat.color }}>{cat.nombre}</span>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-gray-700 font-semibold mb-2">Descripci√≥n</label>
                    <textarea
                      value={descripcion}
                      onChange={(e) => setDescripcion(e.target.value)}
                      placeholder="Describ√≠ el problema..."
                      className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                      rows="4"
                    />
                  </div>

                  <div>
                    <label className="block text-gray-700 font-semibold mb-2">Foto del problema</label>
                    <input
                      type="file"
                      accept="image/*"
                      capture="environment"
                      onChange={handleFotoChange}
                      className="hidden"
                      id="foto-input"
                    />
                    <label
                      htmlFor="foto-input"
                      className="block w-full p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-blue-500 transition"
                    >
                      {previsualizacion ? (
                        <img src={previsualizacion} alt="Preview" className="max-h-48 mx-auto rounded" />
                      ) : (
                        <>
                          <div className="text-4xl mb-2">üì∑</div>
                          <div className="text-gray-600">Tocar para tomar foto</div>
                        </>
                      )}
                    </label>
                  </div>

                  <button
                    onClick={handleCrear}
                    disabled={cargando || !categoria || !descripcion || !foto}
                    className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    {cargando ? 'Creando...' : '‚úÖ Crear Reporte'}
                  </button>
                </div>
              </div>
            );
          };

          // ========================================
          // VISTA: DETALLE DE REPORTE
          // ========================================
          const VistaDetalle = () => {
            if (!reporteActual) return null;

            const categoria = CATEGORIAS.find(c => c.id === reporteActual.categoria);
            const sucursal = SUCURSALES.find(s => s.id === reporteActual.sucursal);
            const [fotoSolucion, setFotoSolucion] = useState(null);
            const [previsualizacionSolucion, setPrevisualizacionSolucion] = useState(null);

            const handleFotoSolucionChange = async (e) => {
              const file = e.target.files[0];
              if (file) {
                try {
                  const fotoComprimida = await comprimirFoto(file);
                  setFotoSolucion(fotoComprimida);
                  
                  const reader = new FileReader();
                  reader.onload = (e) => setPrevisualizacionSolucion(e.target.result);
                  reader.readAsDataURL(fotoComprimida);
                } catch (error) {
                  console.error('Error al comprimir foto:', error);
                  alert('Error al procesar la foto');
                }
              }
            };

            const handleResolver = async () => {
              if (!fotoSolucion) {
                alert('Por favor tom√° una foto de la soluci√≥n');
                return;
              }

              setCargando(true);

              try {
                const storageRef = storage.ref(`soluciones/${Date.now()}_${fotoSolucion.name}`);
                await storageRef.put(fotoSolucion);
                const fotoURL = await storageRef.getDownloadURL();

                await db.collection('reportes').doc(reporteActual.id).update({
                  estado: 'resuelto',
                  fotoSolucion: fotoURL,
                  resueltoPor: usuario,
                  fechaResolucion: new Date()
                });

                alert('‚úÖ Reporte resuelto exitosamente');
                setVista('lista');
              } catch (error) {
                console.error('Error al resolver reporte:', error);
                alert('Error al resolver reporte');
              } finally {
                setCargando(false);
              }
            };

            const handleEliminar = async () => {
              if (!esAdmin) {
                alert('Solo administradores pueden eliminar reportes');
                return;
              }

              if (!confirm('¬øEst√°s seguro de eliminar este reporte?')) return;

              try {
                if (reporteActual.fotoProblema) {
                  const refProblema = storage.refFromURL(reporteActual.fotoProblema);
                  await refProblema.delete().catch(() => {});
                }
                if (reporteActual.fotoSolucion) {
                  const refSolucion = storage.refFromURL(reporteActual.fotoSolucion);
                  await refSolucion.delete().catch(() => {});
                }

                await db.collection('reportes').doc(reporteActual.id).delete();

                alert('‚úÖ Reporte eliminado');
                setVista('lista');
              } catch (error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar reporte');
              }
            };

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-blue-600 text-white p-6">
                  <button
                    onClick={() => setVista('lista')}
                    className="mb-4 text-blue-100 hover:text-white"
                  >
                    ‚Üê Volver
                  </button>
                  <h1 className="text-2xl font-bold">Detalle del Reporte</h1>
                  {sucursal && (
                    <p className="text-blue-100 text-sm mt-1">üìç {sucursal.nombre}</p>
                  )}
                </div>

                <div className="p-6 space-y-6">
                  <div className="bg-white rounded-lg p-6 shadow">
                    <div className="flex items-center gap-3 mb-4">
                      <span className="text-3xl">{categoria?.icon}</span>
                      <div>
                        <div className="font-bold text-xl" style={{ color: categoria?.color }}>
                          {categoria?.nombre}
                        </div>
                        <div className="text-sm text-gray-500">
                          Reportado por {reporteActual.reportadoPor}
                        </div>
                      </div>
                    </div>

                    <div className={`inline-block px-4 py-2 rounded-full font-medium mb-4 ${
                      reporteActual.estado === 'abierto'
                        ? 'bg-red-100 text-red-700'
                        : 'bg-green-100 text-green-700'
                    }`}>
                      {reporteActual.estado === 'abierto' ? 'üî¥ Abierto' : '‚úÖ Resuelto'}
                    </div>

                    <p className="text-gray-700 mb-4">{reporteActual.descripcion}</p>

                    <div className="text-sm text-gray-500">
                      Creado: {new Date(reporteActual.fechaCreacion?.toDate()).toLocaleString('es-AR')}
                    </div>
                  </div>

                  <div className="bg-white rounded-lg p-6 shadow">
                    <h3 className="font-bold text-gray-800 mb-3">Foto del Problema</h3>
                    {reporteActual.fotoProblema ? (
                      <img src={reporteActual.fotoProblema} alt="Problema" className="w-full rounded-lg" />
                    ) : (
                      <div className="text-gray-400 text-center py-8">
                        Foto eliminada por pol√≠tica de retenci√≥n
                      </div>
                    )}
                  </div>

                  {reporteActual.estado === 'resuelto' && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h3 className="font-bold text-gray-800 mb-3">Foto de la Soluci√≥n</h3>
                      {reporteActual.fotoSolucion ? (
                        <>
                          <img src={reporteActual.fotoSolucion} alt="Soluci√≥n" className="w-full rounded-lg mb-3" />
                          <div className="text-sm text-gray-500">
                            Resuelto por {reporteActual.resueltoPor}
                            <br />
                            {new Date(reporteActual.fechaResolucion?.toDate()).toLocaleString('es-AR')}
                          </div>
                        </>
                      ) : (
                        <div className="text-gray-400 text-center py-8">
                          Foto eliminada por pol√≠tica de retenci√≥n
                        </div>
                      )}
                    </div>
                  )}

                  {reporteActual.estado === 'abierto' && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h3 className="font-bold text-gray-800 mb-3">Marcar como Resuelto</h3>
                      
                      <input
                        type="file"
                        accept="image/*"
                        capture="environment"
                        onChange={handleFotoSolucionChange}
                        className="hidden"
                        id="foto-solucion-input"
                      />
                      <label
                        htmlFor="foto-solucion-input"
                        className="block w-full p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-green-500 transition mb-4"
                      >
                        {previsualizacionSolucion ? (
                          <img src={previsualizacionSolucion} alt="Preview" className="max-h-48 mx-auto rounded" />
                        ) : (
                          <>
                            <div className="text-4xl mb-2">üì∑</div>
                            <div className="text-gray-600">Tocar para tomar foto de la soluci√≥n</div>
                          </>
                        )}
                      </label>

                      <button
                        onClick={handleResolver}
                        disabled={cargando || !fotoSolucion}
                        className="w-full bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-300"
                      >
                        {cargando ? 'Resolviendo...' : '‚úÖ Marcar como Resuelto'}
                      </button>
                    </div>
                  )}

                  {esAdmin && (
                    <button
                      onClick={handleEliminar}
                      className="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition"
                    >
                      üóëÔ∏è Eliminar Reporte
                    </button>
                  )}
                </div>
              </div>
            );
          };

          // ========================================
          // VISTA: DASHBOARD
          // ========================================
          const VistaDashboard = () => {
            const stats = {
              total: reportes.length,
              abiertos: reportes.filter(r => r.estado === 'abierto').length,
              resueltos: reportes.filter(r => r.estado === 'resuelto').length,
              tasaResolucion: reportes.length > 0
                ? Math.round((reportes.filter(r => r.estado === 'resuelto').length / reportes.length) * 100)
                : 0
            };

            const statsPorSucursal = esAdmin && sucursalActiva === 'TODAS' 
              ? SUCURSALES.map(suc => {
                  const reportesSuc = reportes.filter(r => r.sucursal === suc.id);
                  const resueltosSuc = reportesSuc.filter(r => r.estado === 'resuelto').length;
                  return {
                    ...suc,
                    total: reportesSuc.length,
                    abiertos: reportesSuc.filter(r => r.estado === 'abierto').length,
                    resueltos: resueltosSuc,
                    tasaResolucion: reportesSuc.length > 0 
                      ? Math.round((resueltosSuc / reportesSuc.length) * 100)
                      : 0
                  };
                }).filter(s => s.total > 0).sort((a, b) => b.tasaResolucion - a.tasaResolucion)
              : null;

            const porCategoria = CATEGORIAS.map(cat => {
              const reportesCat = reportes.filter(r => r.categoria === cat.id);
              return {
                ...cat,
                total: reportesCat.length,
                abiertos: reportesCat.filter(r => r.estado === 'abierto').length,
                resueltos: reportesCat.filter(r => r.estado === 'resuelto').length
              };
            }).filter(cat => cat.total > 0);

            const reportadores = {};
            reportes.forEach(r => {
              reportadores[r.reportadoPor] = (reportadores[r.reportadoPor] || 0) + 1;
            });
            const topReportadores = Object.entries(reportadores)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5);

            const resolvedores = {};
            reportes.filter(r => r.resueltoPor).forEach(r => {
              resolvedores[r.resueltoPor] = (resolvedores[r.resueltoPor] || 0) + 1;
            });
            const topResolvedores = Object.entries(resolvedores)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5);

            return (
              <div className="min-h-screen bg-gray-50">
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
                  <button
                    onClick={() => setVista('lista')}
                    className="mb-4 text-blue-100 hover:text-white"
                  >
                    ‚Üê Volver
                  </button>
                  <h1 className="text-2xl font-bold mb-2">üìä Dashboard</h1>
                  <p className="text-blue-100">
                    {sucursalActiva === 'TODAS' 
                      ? 'Todas las Sucursales' 
                      : SUCURSALES.find(s => s.id === sucursalActiva)?.nombre
                    }
                  </p>
                </div>

                <div className="p-6 space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white rounded-lg p-4 shadow">
                      <div className="text-3xl font-bold text-blue-600">{stats.total}</div>
                      <div className="text-sm text-gray-600">Total Reportes</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow">
                      <div className="text-3xl font-bold text-red-600">{stats.abiertos}</div>
                      <div className="text-sm text-gray-600">Abiertos</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow">
                      <div className="text-3xl font-bold text-green-600">{stats.resueltos}</div>
                      <div className="text-sm text-gray-600">Resueltos</div>
                    </div>
                    <div className="bg-white rounded-lg p-4 shadow">
                      <div className="text-3xl font-bold text-purple-600">{stats.tasaResolucion}%</div>
                      <div className="text-sm text-gray-600">Tasa Resoluci√≥n</div>
                    </div>
                  </div>

                  {statsPorSucursal && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">üè™ Por Sucursal</h2>
                      <div className="space-y-3">
                        {statsPorSucursal.map(suc => (
                          <div key={suc.id} className="border-b border-gray-100 pb-3 last:border-0">
                            <div className="flex justify-between items-center mb-2">
                              <div className="font-semibold text-gray-800">{suc.nombre}</div>
                              <div className="flex items-center gap-4">
                                <span className="text-sm text-gray-600">{suc.total} reportes</span>
                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                  suc.tasaResolucion >= 80 ? 'bg-green-100 text-green-700' :
                                  suc.tasaResolucion >= 60 ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-red-100 text-red-700'
                                }`}>
                                  {suc.tasaResolucion}%
                                </span>
                              </div>
                            </div>
                            <div className="flex gap-4 text-xs">
                              <span className="text-red-600">{suc.abiertos} abiertos</span>
                              <span className="text-green-600">{suc.resueltos} resueltos</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="bg-white rounded-lg p-6 shadow">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Por Categor√≠a</h2>
                    <div className="space-y-4">
                      {porCategoria.map(cat => (
                        <div key={cat.id}>
                          <div className="flex justify-between items-center mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-xl">{cat.icon}</span>
                              <span className="font-semibold text-gray-900">{cat.nombre}</span>
                            </div>
                            <span className="font-bold text-xl" style={{ color: cat.color }}>{cat.total}</span>
                          </div>
                          <div className="flex justify-end gap-4 text-xs">
                            <span className="text-red-600 font-medium">{cat.abiertos} abiertos</span>
                            <span className="text-green-600 font-medium">{cat.resueltos} resueltos</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {topReportadores.length > 0 && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">üèÜ Top Reportadores</h2>
                      <div className="space-y-3">
                        {topReportadores.map(([nombre, cantidad], idx) => (
                          <div key={nombre} className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                idx === 0 ? 'bg-yellow-400 text-yellow-900' :
                                idx === 1 ? 'bg-gray-300 text-gray-700' :
                                idx === 2 ? 'bg-orange-400 text-orange-900' :
                                'bg-gray-100 text-gray-600'
                              }`}>
                                {idx + 1}
                              </div>
                              <span className="font-medium text-gray-800">{nombre}</span>
                            </div>
                            <span className="font-bold text-blue-600">{cantidad}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {topResolvedores.length > 0 && (
                    <div className="bg-white rounded-lg p-6 shadow">
                      <h2 className="text-xl font-bold text-gray-800 mb-4">‚ö° Top Resolvedores</h2>
                      <div className="space-y-3">
                        {topResolvedores.map(([nombre, cantidad], idx) => (
                          <div key={nombre} className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                idx === 0 ? 'bg-yellow-400 text-yellow-900' :
                                idx === 1 ? 'bg-gray-300 text-gray-700' :
                                idx === 2 ? 'bg-orange-400 text-orange-900' :
                                'bg-gray-100 text-gray-600'
                              }`}>
                                {idx + 1}
                              </div>
                              <span className="font-medium text-gray-800">{nombre}</span>
                            </div>
                            <span className="font-bold text-green-600">{cantidad}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {esAdmin && (
                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                      <div className="flex gap-3">
                        <div className="text-2xl">üßπ</div>
                        <div>
                          <div className="font-semibold text-blue-900">Limpieza Autom√°tica Activa</div>
                          <div className="text-sm text-blue-700">
                            Las fotos de reportes resueltos se eliminan autom√°ticamente despu√©s de {DIAS_RETENCION} d√≠as.
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          };

          return (
            <div>
              {vista === 'login' && <VistaLogin />}
              {vista === 'lista' && <VistaLista />}
              {vista === 'crear' && <VistaCrear />}
              {vista === 'detalle' && <VistaDetalle />}
              {vista === 'dashboard' && <VistaDashboard />}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FerniApp />);
    </script>

    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</body>
</html>
